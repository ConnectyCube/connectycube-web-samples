webpackHotUpdate("main",{"./src/call-service.js":
/*!*****************************!*\
  !*** ./src/call-service.js ***!
  \*****************************/
/*! exports provided: default */function(e,t,n){"use strict";n.r(t);var i,s=n(/*! handlebars */"./node_modules/handlebars/dist/cjs/handlebars.js"),a=n.n(s),o=n(/*! ./config */"./src/config.js");function c(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var d="iOS"===(null===(i=window.device)||void 0===i?void 0:i.platform);t.default=new function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r(this,"init",(function(){ConnectyCube.videochat.onCallListener=t.onCallListener.bind(t),ConnectyCube.videochat.onAcceptCallListener=t.onAcceptCallListener.bind(t),ConnectyCube.videochat.onRejectCallListener=t.onRejectCallListener.bind(t),ConnectyCube.videochat.onStopCallListener=t.onStopCallListener.bind(t),ConnectyCube.videochat.onUserNotAnswerListener=t.onUserNotAnswerListener.bind(t),ConnectyCube.videochat.onRemoteStreamListener=t.onRemoteStreamListener.bind(t),ConnectyCube.videochat.onDevicesChangeListener=t.onDevicesChangeListener.bind(t),document.getElementById("call-modal-reject").addEventListener("click",(function(){return t.rejectCall()})),document.getElementById("call-modal-accept").addEventListener("click",(function(){return t.acceptCall()}))})),r(this,"$calling",document.getElementById("signal-in")),r(this,"$dialing",document.getElementById("signal-out")),r(this,"$endCall",document.getElementById("signal-end")),r(this,"$modal",document.getElementById("call-modal-icoming")),r(this,"$muteUnmuteButton",document.getElementById("videochat-mute-unmute")),r(this,"$switchCameraButton",document.getElementById("videochat-switch-camera")),r(this,"$switchSharingScreenButton",document.getElementById("videochat-sharing-screen")),r(this,"mediaParams",{audio:!0,video:!0,elementId:"localStream",options:{muted:!0,mirror:!0}}),r(this,"_session",null),r(this,"mediaDevicesIds",[]),r(this,"activeDeviceId",null),r(this,"isAudioMuted",!1),r(this,"isSharingScreen",!1),r(this,"startEventSharinScreen",null),r(this,"addStreamElements",(function(e){var t=document.getElementById("videochat-streams"),n=document.getElementById("videochat-streams-template"),i=a.a.compile(n.innerHTML);2===e.length?t.classList.value="grid-2-1":3===e.length&&(t.classList.value="grid-2-2"),document.getElementById("call").classList.add("hidden"),document.getElementById("videochat").classList.remove("hidden"),t.innerHTML=i({opponents:e})})),r(this,"onCallListener",(function(e,n){return e.initiatorID!==e.currentUserID&&(t._session?(t.rejectCall(e,{busy:!0}),!1):(t._session=e,void t.showIncomingCallModal()))})),r(this,"onAcceptCallListener",(function(e,n,i){if(n===e.currentUserID)return t.$modal.classList.contains("show")&&(t._session=null,t.hideIncomingCallModal(),t.showSnackbar("You have accepted the call on other side")),!1;var s=t._getUserById(n,"name"),a="".concat(s," has accepted the call");t.showSnackbar(a),t.$dialing.pause()})),r(this,"onRejectCallListener",(function(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(n===e.currentUserID)return t.$modal.classList.contains("show")&&(t._session=null,t.hideIncomingCallModal(),t.showSnackbar("You have rejected the call on other side")),!1;var s=t._getUserById(n,"name"),a=i.busy?"".concat(s," is busy"):"".concat(s," rejected the call request");t.stopCall(n),t.showSnackbar(a)})),r(this,"onStopCallListener",(function(e,n,i){if(!t._session)return!1;var s=e.initiatorID===n,a=t._getUserById(n,"name"),o="".concat(a," has ").concat(s?"stopped":"left"," the call");t.showSnackbar(o),s?(t.$modal.classList.contains("show")&&t.hideIncomingCallModal(),t.stopCall()):t.stopCall(n)})),r(this,"onUserNotAnswerListener",(function(e,n){if(!t._session)return!1;var i=t._getUserById(n,"name"),s="".concat(i," did not answer");t.showSnackbar(s),t.stopCall(n)})),r(this,"onRemoteStreamListener",(function(e,n,i){if(!t._session)return!1;var s="remoteStream-".concat(n);document.getElementById("videochat-stream-loader-".concat(n)).remove(),t._session.attachMediaStream(s,i),t.$muteUnmuteButton.disabled=!1,t.onDevicesChangeListener(),t._prepareVideoElement(s)})),r(this,"acceptCall",(function(){var e={},n=t._session,i=n.opponentsIDs,s=n.initiatorID,a=n.currentUserID,o=[s].concat(c(i)).filter((function(e){return a!==e})).map((function(e){return{id:e,name:t._getUserById(e,"name")}}));t.addStreamElements(o),t.hideIncomingCallModal(),t._session.getUserMedia(t.mediaParams).then((function(n){t._session.accept(e),t.setActiveDeviceId(n),t._prepareVideoElement("localStream")}))})),r(this,"rejectCall",(function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e?e.reject(n):(t._session.reject(n),t._session=null,t.hideIncomingCallModal())})),r(this,"startCall",(function(){var e=[],n=[],i=ConnectyCube.videochat.CallType.VIDEO;document.querySelectorAll(".select-user-checkbox").forEach((function(i){if(i.checked){var s=+i.dataset.id,a=t._getUserById(s,"name");e.push({id:s,name:a}),n.push(s),i.checked=!1}})),e.length>0?(document.getElementById("call").classList.add("hidden"),document.getElementById("videochat").classList.remove("hidden"),t.$dialing.play(),t.addStreamElements(e),t._session=ConnectyCube.videochat.createNewSession(n,i,{}),t._session.getUserMedia(t.mediaParams).then((function(e){t._session.call({}),t.setActiveDeviceId(e),t._prepareVideoElement("localStream")}))):t.showSnackbar("Select at less one user to start Videocall")})),r(this,"stopCall",(function(e){var n=document.getElementById("call"),i=document.getElementById("videochat"),s=document.getElementById("videochat-mute-unmute"),a=document.getElementById("videochat-streams");if(e){document.getElementById("videochat-stream-container-".concat(e)).remove();var o=document.querySelectorAll(".videochat-stream-container");o.length<2?t.stopCall():2===o.length?a.classList.value="":3===o.length&&(a.classList.value="grid-2-1")}else t._session&&(t._session.stop({}),ConnectyCube.videochat.clearSession(t._session.ID),t.$dialing.pause(),t.$calling.pause(),t.$endCall.play(),t.$muteUnmuteButton.disabled=!0,t.$switchCameraButton.disabled=!0,t._session=null,t.mediaDevicesIds=[],t.activeDeviceId=null,t.isAudioMuted=!1,a.innerHTML="",a.classList.value="",n.classList.remove("hidden"),i.classList.add("hidden"),s.classList.remove("muted"),d&&(i.style.background="#000000"))})),r(this,"onDevicesChangeListener",(function(){d||ConnectyCube.videochat.getMediaDevices("videoinput").then((function(e){var n;(t.mediaDevicesIds=null==e?void 0:e.map((function(e){return e.deviceId})),t.mediaDevicesIds.length<2)?(t.$switchCameraButton.disabled=!0,(null===(n=t.mediaDevicesIds)||void 0===n?void 0:n[0])!==t.activeDeviceId&&t.switchCamera()):t.$switchCameraButton.disabled=!1}))})),r(this,"setActiveDeviceId",(function(e){if(e&&!d){var n=e.getVideoTracks()[0].getSettings();t.activeDeviceId=n.deviceId}})),r(this,"setAudioMute",(function(){var e=document.getElementById("videochat-mute-unmute");t.isAudioMuted?(t._session.unmute("audio"),t.isAudioMuted=!1,e.classList.remove("muted")):(t._session.mute("audio"),t.isAudioMuted=!0,e.classList.add("muted"))})),r(this,"switchCamera",(function(){var e=t.mediaDevicesIds.find((function(e){return e!==t.activeDeviceId}));t._session.switchMediaTracks({video:e}).then((function(){t.activeDeviceId=e,t.isAudioMuted&&t._session.mute("audio")}))})),r(this,"sharingScreen",(function(){if(!t.isSharingScreen)return t._session.getDisplayMedia(t.mediaParams,!0).then((function(e){t.updateStream(e),t.isSharingScreen=!0,t.startEventSharinScreen=e.getVideoTracks()[0].addEventListener("ended",(function(){return t.stopSharingScreen()}))}),(function(e){console.warn("[Get display media error]",e,t.mediaParam),t.stopSharingScreen()}));t.stopSharingScreen()})),r(this,"updateStream",(function(e){t._session.call({}),t.setActiveDeviceId(e),t._prepareVideoElement("localStream")})),r(this,"stopSharingScreen",(function(){return t._session.getUserMedia(t.mediaParams,!0).then((function(e){t.updateStream(e),t.isSharingScreen=!1,t.startEventSharinScreen=null}))})),r(this,"showSnackbar",(function(e){var t=document.getElementById("snackbar");t.innerHTML=e,t.classList.add("show"),setTimeout((function(){t.innerHTML="",t.classList.remove("show")}),3e3)})),r(this,"showIncomingCallModal",(function(){return t._incomingCallModal("show")})),r(this,"hideIncomingCallModal",(function(){return t._incomingCallModal("hide")})),r(this,"_incomingCallModal",(function(e){var n=document.getElementById("call-modal-initiator");"hide"===e?(n.innerHTML="",t.$modal.classList.remove("show"),t.$calling.pause()):(n.innerHTML=t._getUserById(t._session.initiatorID,"name"),t.$modal.classList.add("show"),t.$calling.play())})),r(this,"_getUserById",(function(e,t){var n=o.users.find((function(t){return t.id==e}));return"string"==typeof t?n[t]:n})),r(this,"_prepareVideoElement",(function(e){var t=document.getElementById(e);t.style.visibility="visible",d&&(document.getElementById("videochat").style.background="transparent",t.style.backgroundColor="",t.style.zIndex=-1)}))}}});
//# sourceMappingURL=main.map